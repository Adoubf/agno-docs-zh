---
title: äººåœ¨å›è·¯
---
äººå·¥ä»‹å…¥å¾ªç¯ï¼ˆHITLï¼‰å…è®¸åœ¨æ‰§è¡Œå·¥å…·è°ƒç”¨å‰åè·å–ç”¨æˆ·è¾“å…¥ã€‚

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºå¦‚ä½•åˆ©ç”¨å·¥å…·é’©å­åœ¨æ‰§è¡Œå·¥å…·è°ƒç”¨å‰è·å–ç”¨æˆ·ç¡®è®¤ã€‚

## ç¤ºä¾‹ï¼šä½¿ç”¨å·¥å…·é’©å­å®ç°äººå·¥ä»‹å…¥å¾ªç¯

æœ¬ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ï¼š
- ä¸ºå·¥å…·æ·»åŠ ç”¨æˆ·ç¡®è®¤é’©å­
- å¤„ç†å·¥å…·æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ç”¨æˆ·è¾“å…¥
- æ ¹æ®ç”¨æˆ·é€‰æ‹©ä¼˜é›…å–æ¶ˆæ“ä½œ

```python hitl.py
"""ğŸ¤ Human-in-the-Loop: Adding User Confirmation to Tool Calls

This example shows how to implement human-in-the-loop functionality in your Agno tools.
It shows how to:
- Add tool hooks to tools for user confirmation
- Handle user input during tool execution
- Gracefully cancel operations based on user choice

Some practical applications:
- Confirming sensitive operations before execution
- Reviewing API calls before they're made
- Validating data transformations
- Approving automated actions in critical systems

Run `pip install openai httpx rich agno` to install dependencies.
"""

import json
from typing import Any, Callable, Dict, Iterator

import httpx
from agno.agent import Agent
from agno.exceptions import StopAgentRun
from agno.models.openai import OpenAIChat
from agno.tools import FunctionCall, tool
from rich.console import Console
from rich.pretty import pprint
from rich.prompt import Prompt

# è¿™æ˜¯ print_response æ–¹æ³•ä½¿ç”¨çš„æ§åˆ¶å°å®ä¾‹
# æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€åŠŸèƒ½æ¥åœæ­¢å’Œé‡å¯å®æ—¶æ˜¾ç¤ºï¼Œå¹¶è¯·æ±‚ç”¨æˆ·ç¡®è®¤ã€‚
console = Console()


def confirmation_hook(
    function_name: str, function_call: Callable, arguments: Dict[str, Any]
):
    # ä»æ§åˆ¶å°è·å–å®æ—¶æ˜¾ç¤ºå®ä¾‹
    live = console._live

    # æš‚åœæ­¢å®æ—¶æ˜¾ç¤ºä»¥ä¾¿è¯·æ±‚ç”¨æˆ·ç¡®è®¤
    live.stop()  # type: ignore

    # è¯·æ±‚ç¡®è®¤
    console.print(f"\nAbout to run [bold blue]{fc.function.name}[/]")
    message = (
        Prompt.ask("Do you want to continue?", choices=["y", "n"], default="y")
        .strip()
        .lower()
    )

    # é‡æ–°å¯åŠ¨å®æ—¶æ˜¾ç¤º
    live.start()  # type: ignore

    # å¦‚æœç”¨æˆ·ä¸å¸Œæœ›ç»§ç»­ï¼Œåˆ™æŠ›å‡º StopExecution å¼‚å¸¸
    if message != "y":
        raise StopAgentRun(
            "Tool call cancelled by user",
            agent_message="Stopping execution as permission was not granted.",
        )
    
    # è°ƒç”¨è¯¥å‡½æ•°
    result = function_call(**arguments)

    # å¯é€‰è½¬æ¢ç»“æœ

    return result


@tool(tool_hooks=[confirmation_hook])
def get_top_hackernews_stories(num_stories: int) -> Iterator[str]:
    """Fetch top stories from Hacker News.

    Args:
        num_stories (int): Number of stories to retrieve

    Returns:
        str: JSON string containing story details
    """
    # è·å–çƒ­é—¨æ–°é—»ID
    response = httpx.get("https://hacker-news.firebaseio.com/v0/topstories.json")
    story_ids = response.json()

    # æ”¶ç›Šæ•…äº‹è¯¦æƒ…
    final_stories = []
    for story_id in story_ids[:num_stories]:
        story_response = httpx.get(
            f"https://hacker-news.firebaseio.com/v0/item/{story_id}.json"
        )
        story = story_response.json()
        if "text" in story:
            story.pop("text", None)
        final_stories.append(story)

    return json.dumps(final_stories)


# åˆå§‹åŒ–æ™ºèƒ½ä½“æ—¶è®¾å®šç²¾é€šæŠ€æœ¯çš„ä¸ªæ€§ç‰¹å¾ä¸æ˜ç¡®æŒ‡ä»¤
agent = Agent(
    model=OpenAIChat(id="gpt-4o-mini"),
    tools=[get_top_hackernews_stories],
    markdown=True,
)

agent.print_response(
    "Fetch the top 2 hackernews stories?", stream=True, console=console
)
```